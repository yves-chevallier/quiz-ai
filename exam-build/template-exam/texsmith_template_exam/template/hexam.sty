\directlua{luaotfload.add_fallback
  ("fontfallback",
  {
      "NotoColorEmoji:mode=harf;",
      "NotoNaskhArabic:mode=harf;",
      "NotoSerifHebrew:mode=harf;",
      "NotoSerifDevanagari:mode=harf;",
      "NotoSerifTamil:mode=harf;",
      "NotoSerifTibetan:mode=harf;",
      "NotoSerifCJKkr:mode=harf;",
      "NotoSans:mode=harf;",
      "NotoSansSymbols2-Regular:mode=harf;",
      "NotoSansMath-Regular:mode=harf;",
      "NotoMusic-Regular:mode=harf;",
    }
  )}

\setmainfont{Latin Modern Roman}[
  Ligatures=TeX,
  SmallCapsFont = Latin Modern Roman Caps,
  RawFeature = {fallback=fontfallback},
]

\setsansfont{Latin Modern Sans}[
  RawFeature={fallback=fontfallback}
]

\setmonofont{FreeMono}[
  Scale=0.9,
  ItalicFont={* Oblique},
  BoldFont={* Bold},
  BoldItalicFont={* Bold Oblique},
  RawFeature={fallback=fontfallback}
]

\usetikzlibrary{calc}
\setmonofont{inconsolata}

\newcommand{\anchorbox}[2]{%
  \sbox\@tempboxa{#2}%
  \leavevmode
  \rlap{\raise\ht\@tempboxa\hbox{\hyper@anchorstart{#1-tl}\hyper@anchorend}}%
  \rlap{\lower\dp\@tempboxa\hbox{\hyper@anchorstart{#1-bl}\hyper@anchorend}}%
  \hb@xt@0pt{\hskip\wd\@tempboxa\raise\ht\@tempboxa\hbox{\hyper@anchorstart{#1-tr}\hyper@anchorend}\hss}%
  \hb@xt@0pt{\hskip\wd\@tempboxa\lower\dp\@tempboxa\hbox{\hyper@anchorstart{#1-br}\hyper@anchorend}\hss}%
  \box\@tempboxa
}

\newcounter{NoTableEntry}
\renewcommand*{\theNoTableEntry}{NTE-\the\value{NoTableEntry}}

\newcommand*{\strike}[2]{%
\multicolumn{1}{#1}{%
\stepcounter{NoTableEntry}%
\vadjust pre{\zsavepos{\theNoTableEntry t}}% top
\vadjust{\zsavepos{\theNoTableEntry b}}% bottom
\zsavepos{\theNoTableEntry l}% left
\hspace{0pt plus 1filll}%
#2% content
\hspace{0pt plus 1filll}%
\zsavepos{\theNoTableEntry r}% right
\tikz[overlay]{%
\draw
let
\n{llx}={\zposx{\theNoTableEntry l}sp-\zposx{\theNoTableEntry r}sp-\tabcolsep},
\n{urx}={\tabcolsep},
\n{lly}={\zposy{\theNoTableEntry b}sp-\zposy{\theNoTableEntry r}sp},
\n{ury}={\zposy{\theNoTableEntry t}sp-\zposy{\theNoTableEntry r}sp}
in
(\n{llx}, \n{lly}) -- (\n{urx}, \n{ury})
;
\draw
let
\n{llx}={\zposx{\theNoTableEntry l}sp-\zposx{\theNoTableEntry r}sp-\tabcolsep},
\n{urx}={\tabcolsep},
\n{lly}={\zposy{\theNoTableEntry b}sp-\zposy{\theNoTableEntry r}sp},
\n{ury}={\zposy{\theNoTableEntry t}sp-\zposy{\theNoTableEntry r}sp}
in
(\n{llx}, \n{ury}) -- (\n{urx}, \n{lly})
;
}%
}%
}

\setlength{\parskip}{1em}

\definecolor{GitHubGray}{rgb}{0.9,0.9,0.9}
\definecolor{HexamSolutionColor}{RGB}{155,0,0}

\newcommand{\hexamSolutionStyle}{\color{HexamSolutionColor}}
\newcommand{\hexamSolutionSetup}{%
  \hexamSolutionStyle
}

\newlength{\HexamAnswerAbove}
\newlength{\HexamAnswerBelow}
\setlength{\HexamAnswerAbove}{9mm}
\setlength{\HexamAnswerBelow}{1mm}
\newcommand{\HexamAnswerStrut}{%
  \rule[-\HexamAnswerBelow]{0pt}{\dimexpr\HexamAnswerAbove+\HexamAnswerBelow\relax}%
}
\setlength{\linefillheight}{\dimexpr\HexamAnswerAbove+\HexamAnswerBelow\relax}
\setlength{\dottedlinefillheight}{\dimexpr\HexamAnswerAbove+\HexamAnswerBelow\relax}

\unframedsolutions
\renewcommand{\solutiontitle}{}
\SolutionEmphasis{\hexamSolutionSetup}

\lstset{
  language=python,
  breaklines=true,
  basicstyle=\ttfamily\footnotesize\color{black},
  keywordstyle=\bfseries,
  commentstyle=\itshape\color{black!40!black},
  keepspaces=true,
  showspaces=false,
  showtabs=true,
  tabsize=3,
  upquote=true,
  aboveskip=2pt,
  belowskip=2pt,
  framexleftmargin=2pt,
  extendedchars=true,
  inputencoding=utf8,
}

% Listing
\mdfsetup{%
  roundcorner=2pt,
  innerleftmargin=3pt,
  innertopmargin=3pt,
  linecolor=black!60,%
  linewidth=0.3pt,
  innerbottommargin=3pt
}


\usemintedstyle{bw}

\newtcblisting[auto counter,number within=section,
  list inside=mypyg]{code}[3][]{%
  breakable,
  listing only,
  enhanced,
  colback=white,
  pad at break*=1mm,
  toptitle=0.15em,
  bottomtitle=0.1em,
  boxrule=0.15mm,
  arc=3pt,
  minted language=#2,
  top=1mm,
  bottom=1mm,
  left=0pt,
  right=0pt,
  boxsep=0pt,
  minted options={%
      tabsize=4,
      breaklines,
      xleftmargin=0.4em,
      fontsize=\footnotesize,
      highlightcolor=gray!30,
      ignorelexererrors,
      #3
    },
  #1
}

\newcommand{\inlinecpp}[1]{%
  \tcbox[on line, boxsep=1pt, left=1pt, right=1pt, top=1pt, bottom=1pt,
    colframe=GitHubGray, colback=GitHubGray, arc=1pt, outer arc=2pt,
    boxrule=0pt, bottomrule=0pt, toprule=0pt, leftrule=0pt, rightrule=0pt]{{\lstinline{#1}}}%
}

\makeatletter
\def\@fillin@relay[#1]{%
  \leavevmode
  \HexamAnswerStrut
  \ifprintanswers
    \rlap{\raise -\answerclearance \hbox to #1{\dotfill}}%
    \begingroup
      \setbox0 \hbox{\color@begingroup
        \CorrectChoice@Emphasis \hexamSolutionStyle \fillin@ans \color@endgroup}%
      \ifdim\wd0 > #1\relax
        \hbox{\color@begingroup
          \CorrectChoice@Emphasis \hexamSolutionStyle \fillin@ans \color@endgroup}%
      \else
        \hbox to #1{\color@begingroup
          \CorrectChoice@Emphasis \hexamSolutionStyle \hfil \fillin@ans \hfil \color@endgroup}%
      \fi
    \endgroup
  \else
    \raise -\answerclearance \hbox to #1{\dotfill}%
  \fi
}
\makeatother

\makeatletter
\xpatchcmd{\do@fillwithdottedlines}
  {\vrule height \dottedlinefillheight depth \z@ width \z@}
  {\vrule height \HexamAnswerAbove depth \HexamAnswerBelow width \z@}
  {}{}
\makeatother

\NewTotalTCBox{\CD}{v}{verbatim,boxsep=1pt, left=1pt, right=1pt, top=1pt, bottom=1pt,arc=1pt, outer arc=2pt,colframe=GitHubGray,colback=GitHubGray}{\lstinline[]^#1^}

\makeatletter
\providecommand{\@school}{}
\providecommand{\@department}{}
\makeatother
\DeclareRobustCommand*\school[1]{\gdef\@school{#1}}
\DeclareRobustCommand*\department[1]{\gdef\@department{#1}}

\makeatletter
\newcommand{\HexamCoverPage}{%
  \newpage

\makebox[\textwidth][r]{%
  \vtop{%
    \hbox{\begin{minipage}[t]{3.5cm}\raggedleft\bfseries Nom, Prénom~:\end{minipage}%
    \hspace{0.5em}%
    \begin{minipage}[t]{8cm}\anchorbox{cover-name-box}{\fbox{\makebox[\linewidth][l]{\rule{0pt}{0.8cm}}}}\end{minipage}}%
  }%
}
  \logo{1cm}{1cm}


  \null
  \vskip 7em%
  \begin{center}%
    \let \footnote \thanks
    {\LARGE \@title \par}%
    \vskip 1.0em%
      {\Large \itshape\@school\par}%
    \vskip .2em%
      {\itshape\@department\par}%
    \vskip 1.0em%
    \ifprintanswers
    {\Large \bfseries Solution\par}%
    \fi
    \vskip 2.0em%
      {
        \lineskip .2em%
        \begin{tabular}[t]{c}%
          \@author
        \end{tabular}\par}%
    \vskip 1em%
      {\large \@date}%
  \end{center}%
  \par
\vskip 1.5em}
\let\@maketitle\HexamCoverPage
\makeatother


%% Question format

% Add number before the question title
% Disabled multicolumn/label patches for template portability
%\xpatchcmd\@multicolumntable{|c|c|c|c}{|l|c|c|c}{}{}
%\xpatchcmd\questions{\def\@currentlabel{\thequestiontitle}}{\def\@currentlabel{\thequestion. \thequestiontitle}}{}{}

% Configure the question title
% \qformat{
%   \large\textbf{Problème \thequestion~: \thequestiontitle}
%   \quad \hfill(\totalpoints{} \points)
%   \vrule depth 1.5em width 0pt
% }

\pointsdroppedatright
\colorfillwithdottedlines

\definecolor{FillWithDottedLinesColor}{gray}{0.3}

\setlength{\gridsize}{4mm}
\setlength{\gridlinewidth}{0.15pt}

%% Headers and footers

\footer{Problème \thequestion}
{Page \thepage\ sur \numpages}
{\iflastpage{Fin du travail.}{Aller à la page suivante\ldots}}

\pagestyle{headandfoot}

\makeatletter
\firstpageheader{}{}{}
\runningheader{}{}{}
\makeatother

\footer{Problème \thequestion}
{Page \thepage\ sur \numpages}
{\iflastpage{Fin du travail.}{Aller à la page suivante\ldots}}
